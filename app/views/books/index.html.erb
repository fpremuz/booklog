<div class="flex justify-between items-center mb-8">
  <h1 class="text-3xl font-bold">Books</h1>
  <% if authenticated? %>
    <%= link_to "New Book", new_book_path, class: "bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded" %>
  <% end %>
</div>

<%= form_with url: books_path, method: :get, local: true do %>
  <div class="mb-4 flex flex-wrap items-end gap-4">
    <div>
      <%= label_tag :query, "Search Books", class: "block mb-1" %>
      <%= text_field_tag :query, params[:query], placeholder: "Search by title or description", class: "border px-2 py-1 rounded w-48" %>
    </div>

    <div>
      <%= label_tag :status, "Status", class: "block mb-1" %>
      <%= select_tag :status,
          options_for_select(Book::STATUS_OPTIONS.map { |label, value| [label, value] }, params[:status]),
          include_blank: "All Statuses",
          class: "border px-2 py-1 rounded w-40" %>
    </div>

    <div>
      <%= label_tag :rating, "Exact Rating", class: "block mb-1" %>
      <%= select_tag :rating,
          options_for_select((1..5).map { |r| [r, r] }, params[:rating]),
          include_blank: "All Ratings",
          class: "border px-2 py-1 rounded w-32" %>
    </div>

    <div>
      <%= label_tag :rating_filter, "Minimum Rating", class: "block mb-1" %>
      <%= select_tag :rating_filter, 
        options_for_select([["All ratings", ""], ["3 stars or higher", "3"], ["4 stars or higher", "4"], ["5 stars only", "5"]], params[:rating_filter]),
        class: "border px-2 py-1 rounded w-40" %>
    </div>

    <div>
      <%= label_tag :tag, "Filter by Tag", class: "block mb-1" %>
      <%= form_with url: books_path, method: :get, local: true do |f| %>
        <%= f.text_field :tag, class: "border rounded px-2 py-1 mr-2" %>
      <% end %>
    </div>

    <div class="flex gap-2 items-end">
      <%= submit_tag "Search", class: "inline-flex items-center justify-center bg-blue-500 text-white px-3 py-1 rounded h-[38px]" %>
      <%= link_to "Reset Filters", books_path, class: "inline-flex items-center justify-center bg-gray-400 text-black px-3 py-1 rounded h-[38px]" %>
    </div>
    </div>
  </div>
<% end %>

<% if params[:query].blank? && params[:status].blank? %>
  <p class="text-gray-600 mt-2">Showing all books</p>
<% end %>


<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  <% @books.each do |book| %>
    <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-between h-full">
      <div>
        <% if book.cover_image.attached? %>
          <%= image_tag book.cover_image, class: "rounded shadow-md mt-2" %>
        <% else %>
          <div class="mb-4 bg-gray-100 text-gray-500 italic text-center py-12 rounded">
            No image
          </div>
        <% end %>

        <h2 class="text-xl font-bold mb-2"><%= book.title %></h2>

        <% if book.description.present? %>
          <p class="text-gray-600 text-sm mb-4"><%= truncate(book.description, length: 100) %></p>
        <% end %>

         <% if book.status.present? %>
          <% status_class = case book.status
            when "read"
              "bg-green-100 text-green-800"
            when "reading"
              "bg-yellow-100 text-yellow-800"
            when "to_read"
              "bg-gray-100 text-gray-800"
            else
              "bg-gray-200 text-gray-600"
          end %>

          <p class="text-sm text-gray-600 italic mb-2">
            Status:
            <span class="inline-block ml-1 px-3 py-1 rounded-full text-xs font-bold <%= status_class %>">
              <%= book.status.humanize %>
            </span>
          </p>
        <% else %>
          <p class="text-sm text-gray-500 italic mb-2">Status: Not set</p>
        <% end %>

        <p><strong>Rating:</strong>
          <% if book.rating.present? %>
            <% 1.upto(5) do |star| %>
              <span class="text-yellow-400 text-xl">
                <%= star <= (book.rating || 0) ? "‚òÖ" : "‚òÜ" %>
              </span>
            <% end %>
          <% else %>
            Not rated
          <% end %>
        </p>
        
        <% if book.total_pages.present? && book.total_pages > 0 %>
          <% progress = ((book.pages_read.to_f / book.total_pages) * 100).round %>
          <p class="text-sm text-gray-600">üìò <%= progress %>% completed</p>

          <div class="w-full bg-gray-200 rounded-full h-2 mt-1 mb-2">
            <div class="bg-blue-500 h-2 rounded-full" style="width: <%= progress %>%"></div>
          </div>
        <% end %>

        <% if book.status == "read" %>
          <span class="text-green-600 font-semibold">‚úÖ Completed</span>
        <% else %>
          <span class="text-yellow-600 font-semibold">‚è≥ In Progress</span>
        <% end %>

        <% if book.tags.present? %>
          <p class="text-xs text-gray-600 mb-1">Tags: <%= book.tags %></p>
        <% end %>
      </div>

      <div class="mt-4 flex justify-between items-center text-sm text-gray-500">
        <%= link_to "Show", book, class: "hover:underline" %>
        <% if authenticated? %>
          <%= link_to "Edit", edit_book_path(book), class: "hover:underline" %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>